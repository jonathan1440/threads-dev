#!/bin/bash
# Git pre-commit hook for Threads validation
# Install: cp this file to .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit

set -e

# Colors (only if terminal supports it)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    CYAN=''
    NC=''
fi

# Find .threads directory
find_threads_dir() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -d "$dir/.threads" ]]; then
            echo "$dir/.threads"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

THREADS_DIR=$(find_threads_dir) || {
    # No threads directory, skip validation
    exit 0
}

BIN_DIR="$(dirname "$THREADS_DIR")/bin"

# Check if any .threads files are being committed
THREADS_FILES=$(git diff --cached --name-only | grep "^\.threads/" || true)

if [[ -z "$THREADS_FILES" ]]; then
    # No threads files being committed, skip validation
    exit 0
fi

echo -e "${CYAN}Threads: Validating committed files...${NC}"

# Run validation in strict mode
if [[ -x "$BIN_DIR/threads-validate.sh" ]]; then
    if ! "$BIN_DIR/threads-validate.sh" --strict 2>&1 | grep -E "(ERROR|WARN|✓|✗)"; then
        echo -e "${RED}Threads validation failed. Commit aborted.${NC}"
        echo ""
        echo "Run 'threads validate --fix' to attempt automatic fixes."
        echo "Or use 'git commit --no-verify' to skip validation."
        exit 1
    fi
else
    # Fallback: basic YAML syntax check
    for file in $THREADS_FILES; do
        if [[ -f "$file" ]] && [[ "$file" == *.yaml ]]; then
            # Check for tabs
            if grep -q $'\t' "$file"; then
                echo -e "${RED}Error: $file contains tabs (YAML requires spaces)${NC}"
                exit 1
            fi
        fi
    done
fi

echo -e "${GREEN}Threads: Validation passed${NC}"
exit 0
